--[[
Elerium-compatible Auto Kill with Whitelist & Targeting
Chat Commands:
  /ak on         = Auto kill all (except whitelisted)
  /ak off        = Stop auto kill
  /ak add NAME   = Whitelist by username or display name
  /ak clear      = Clear whitelist
  /ak friends    = Whitelist all friends
  /ak target NAME= Enable kill only target
  /ak untarget   = Stop targeted killing
  /ak list       = Print whitelist
]]

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local whitelist = {}
local killAll = false
local targetOnly = false
local targetPlayer = nil

-- Helper: checks if player is whitelisted
local function isWhitelisted(player)
    return whitelist[player.Name]
end

-- Helper: get a player by username or display name (case-insensitive)
local function findPlayer(name)
    name = name:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower() == name or (p.DisplayName and p.DisplayName:lower() == name) then
            return p
        end
    end
    return nil
end

-- Helper: kill a player
local function killPlayer(target)
    local myChar = LocalPlayer.Character
    if not myChar then return end
    local myHand = myChar:FindFirstChild("LeftHand") or myChar:FindFirstChild("RightHand")
    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") and myHand then
        firetouchinterest(target.Character.HumanoidRootPart, myHand, 0)
        firetouchinterest(target.Character.HumanoidRootPart, myHand, 1)
    end
end

-- Auto kill loop
spawn(function()
    while true do
        if killAll then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and not isWhitelisted(player) then
                    if player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
                        killPlayer(player)
                    end
                end
            end
        elseif targetOnly and targetPlayer then
            local player = findPlayer(targetPlayer)
            if player and player ~= LocalPlayer and not isWhitelisted(player) then
                if player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
                    killPlayer(player)
                end
            end
        end
        task.wait(0.15)
    end
end)

-- PlayerAdded: auto-whitelist friends if enabled
Players.PlayerAdded:Connect(function(p)
    if getgenv().autoWhitelistFriends and p:IsFriendsWith(LocalPlayer.UserId) then
        whitelist[p.Name] = true
    end
end)

-- Chat commands
LocalPlayer.Chatted:Connect(function(msg)
    local args = {}
    for word in msg:gmatch("%S+") do table.insert(args, word) end
    if args[1] == "/ak" then
        if args[2] == "on" then
            killAll = true
            targetOnly = false
            print("[AutoKill] Enabled for all players (except whitelist).")
        elseif args[2] == "off" then
            killAll = false
            targetOnly = false
            print("[AutoKill] Disabled.")
        elseif args[2] == "add" and args[3] then
            local p = findPlayer(table.concat(args, " ", 3))
            if p then
                whitelist[p.Name] = true
                print("[AutoKill] Whitelisted: "..p.Name)
            else
                print("[AutoKill] Player not found.")
            end
        elseif args[2] == "clear" then
            for k in pairs(whitelist) do whitelist[k] = nil end
            print("[AutoKill] Whitelist cleared.")
        elseif args[2] == "friends" then
            for _, p in ipairs(Players:GetPlayers()) do
                if p:IsFriendsWith(LocalPlayer.UserId) then
                    whitelist[p.Name] = true
                end
            end
            getgenv().autoWhitelistFriends = true
            print("[AutoKill] All friends whitelisted.")
        elseif args[2] == "target" and args[3] then
            targetPlayer = table.concat(args, " ", 3)
            killAll = false
            targetOnly = true
            print("[AutoKill] Will only target: "..targetPlayer)
        elseif args[2] == "untarget" then
            targetOnly = false
            targetPlayer = nil
            print("[AutoKill] Targeted killing disabled.")
        elseif args[2] == "list" then
            print("[AutoKill] Whitelisted Players:")
            for k in pairs(whitelist) do print("  "..k) end
            if next(whitelist) == nil then print("  (none)") end
        end
    end
end)

print("[Elerium AutoKill] Loaded!")
print("Type /ak on or /ak friends in chat to start. /ak add NAME to whitelist. /ak target NAME to target only a player.")
